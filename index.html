<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Public Safety System - Desktop Dashboard</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Poppins Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

 <style>
      :root{
      --bg-main: rgba(16,18,27,0.45);
      --card-border: rgba(255,255,255,0.08);
      --text-main: #f9fafb;
      --text-muted: rgba(249,250,251,0.6);
      --accent: #3a6df0;
      --accent-light: #5a8bf2;
      --accent-glow: rgba(58, 111, 240, 0.3);
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      --online: #22c55e;
      --fetching: #f59e0b;
      --offline: #ef4444;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.3);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.4);
      --radius: 8px;
      --radius-lg: 20px;
      --radius-xl: 22px;
      --transition: all 0.35s ease;
      --transition-fast: all 0.15s ease;
    }

    *{ 
      box-sizing:border-box;
      margin: 0;
      padding: 0;
    }

    body{
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background: #000;
      padding: 20px;
      overflow: auto;
    }

    /* Video Background */
    #video-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -2;
    }

    .video-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        to bottom,
        rgba(0, 0, 0, 0.2) 0%,
        rgba(0, 0, 0, 0.4) 40%,
        rgba(0, 0, 0, 0.7) 100%
      );
      z-index: -1;
    }

    /* Main Glass Card Container - RESPONSIVE */
    .glass-card {
      width: min(1200px, 100%);
      height: min(800px, calc(100vh - 40px));
      min-height: 650px;
      background: var(--bg-main);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: var(--radius-xl);
      box-shadow: 0 24px 60px rgba(0,0,0,0.65);
      border: 1px solid var(--card-border);
      overflow: hidden;
      position: relative;
      z-index: 1;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
    }

    .glass-card.with-logs {
      width: min(1600px, 100%);
    }

    .glass-card.blurred-bg {
      filter: blur(8px);
      pointer-events: none;
      user-select: none;
    }

    /* HEADER - Redesigned with Status Strip */
    .dash-header{
      padding: 18px 24px 14px;
      position: relative;
      flex-shrink: 0;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .dash-title{
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .dash-title h2{
      margin: 0;
      font-size: 22px;
      font-weight: 700;
      color: var(--text-main);
      letter-spacing: 0.2px;
    }

    .header-actions{
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .icon-btn{
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      padding: 8px 14px;
      border-radius: var(--radius);
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: var(--transition-fast);
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-main);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .icon-btn i {
      width: 14px;
      height: 14px;
      stroke-width: 2;
    }

    /* Status Strip */
    .status-strip {
      height: 4px;
      border-radius: 2px;
      transition: var(--transition);
      background: var(--offline);
    }

    .status-strip.online {
      background: var(--online);
    }

    .status-strip.fetching {
      background: var(--fetching);
    }

    .status-strip.offline {
      background: var(--offline);
    }

    /* Main Content Grid - Responsive */
    .dash-main{
      display: grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: 1fr;
      gap: 16px;
      padding: 0 24px 16px;
      flex: 1;
      min-height: 0;
      overflow: hidden;
      height: calc(100% - 80px);
      transition: grid-template-columns 0.35s ease;
    }

    .glass-card.with-logs .dash-main {
      grid-template-columns: 280px 1fr 420px;
      height: calc(100% - 80px);
    }

    /* For low heights (<= 768px), allow inner scroll instead of overlap */
    @media (max-height: 768px) {
      .dash-main {
        overflow-y: auto;
        min-height: 500px;
      }
    }

    /* Left Column - Cards */
    .left-col{
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: 100%;
      overflow-y: auto;
      padding-right: 4px;
      min-height: 0;
    }

    .left-col::-webkit-scrollbar {
      width: 4px;
    }

    .left-col::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 2px;
    }

    .left-col::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 2px;
    }

    .card{
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      padding: 20px;
      border: 1px solid var(--card-border);
      transition: var(--transition-fast);
      flex-shrink: 0;
    }

    .card:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.12);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .card-header h4{
      margin: 0;
      font-size: 15px;
      color: var(--text-main);
      font-weight: 600;
    }

    .card-header i {
      width: 18px;
      height: 18px;
      stroke-width: 2;
      color: var(--text-muted);
    }

    /* Device Info */
    .device-info {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .device-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .device-line:last-child {
      border-bottom: none;
    }

    .device-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .device-label i {
      width: 14px;
      height: 14px;
      stroke-width: 2;
    }

    .device-value {
      font-size: 14px;
      color: var(--text-main);
      font-weight: 500;
    }

    /* Status indicator */
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--offline);
    }

    .status-dot.online {
      background: var(--online);
    }

    .status-dot.fetching {
      background: var(--fetching);
    }

    .status-dot.offline {
      background: var(--offline);
    }

    /* Location Card */
    .loc-grid {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .loc-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .loc-row:last-child {
      border-bottom: none;
    }

    .loc-label {
      color: var(--text-muted);
      font-size: 13px;
    }

    .loc-value {
      color: var(--text-main);
      font-weight: 500;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      font-size: 13px;
    }

    .address-box {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.04);
      font-size: 13px;
      line-height: 1.4;
      color: var(--text-main);
    }

    .address-box .loc-label {
      display: block;
      margin-bottom: 4px;
    }

    /* Settings Card */
    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .setting-row:last-child {
      border-bottom: none;
    }

    .setting-label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text-main);
    }

    .setting-label i {
      width: 16px;
      height: 16px;
      stroke-width: 2;
      color: var(--text-muted);
    }

    /* Toggle Switch */
    .toggle{
      width: 42px;
      height: 20px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.1);
      position: relative;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .toggle .dot{
      width: 16px;
      height: 16px;
      background: #ffffff;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .toggle.on{
      background: var(--accent);
      border-color: var(--accent);
    }

    .toggle.on .dot{
      transform: translateX(20px);
    }

    /* Custom Select Dropdown */
    .auto-refresh-select {
      position: relative;
      padding: 8px 32px 8px 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: #2e3134;
      color: var(--text-main);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-fast);
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f9fafb' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 14px;
      min-width: 110px;
    }

    .auto-refresh-select:focus {
      outline: none;
      border-color: var(--accent);
      background-color: #323639;
      box-shadow: 0 0 0 2px rgba(58, 111, 240, 0.1);
    }

    .auto-refresh-select option {
      background: #2e3134;
      color: var(--text-main);
      padding: 8px;
      font-size: 13px;
      border: none;
    }

    /* Map Area - FIXED STRUCTURE */
    .map-card{
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      height: 100%;
      position: relative;
      width: 100%;
      overflow: hidden;
    }

    .map-frame{
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      padding: 20px;
      border: 1px solid var(--card-border);
      position: relative;
      width: 100%;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    #map{
      flex: 1 1 auto;
      min-height: 260px;
      border-radius: var(--radius);
      background: #1a1d28;
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    /* Prevent Leaflet from overriding the height */
    #map.leaflet-container {
      height: 100% !important;
      width: 100% !important;
    }

    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-shrink: 0;
      padding-bottom: 0;
    }

    .map-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: var(--text-main);
      font-size: 15px;
    }

    .map-title i {
      width: 18px;
      height: 18px;
      stroke-width: 2;
      color: var(--accent);
    }

    .map-provider {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Map Controls */
    .map-controls{
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-shrink: 0;
      flex-wrap: wrap;
    }

    .btn{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: var(--transition-fast);
      font-family: 'Poppins', sans-serif;
      white-space: nowrap;
      flex: 1;
      min-width: 120px;
      justify-content: center;
    }

    .btn i {
      width: 16px;
      height: 14px;
      stroke-width: 2;
    }

    .btn-refresh{
      background: var(--accent);
      color: white;
    }

    .btn-refresh:hover {
      background: #2a5ce6;
      transform: translateY(-1px);
    }

    .btn-directions{
      background: transparent;
      color: var(--text-main);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .btn-directions:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateY(-1px);
    }

    .btn-expand{
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-main);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .btn-expand:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }

    .btn-logs{
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-main);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .btn-logs:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }

    .btn.disabled{
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    /* Media Panel - COMPACT AND ALWAYS VISIBLE */
    .media-panel {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      border: 1px solid var(--card-border);
      padding: 12px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      height: auto;
      min-height: 90px;
      margin-top: 12px;
    }

    .media-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      height: 100%;
    }

    .media-tile {
      background: rgba(255, 255, 255, 0.02);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.06);
      padding: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: var(--transition-fast);
      height: 100%;
      min-height: 0;
    }

    .media-tile:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

    .media-tile-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .media-tile-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(58, 111, 240, 0.1);
      color: var(--accent);
    }

    .media-tile-icon i {
      width: 20px;
      height: 20px;
      stroke-width: 2;
    }

    .media-tile-info h4 {
      margin: 0;
      font-size: 12px;
      color: var(--text-main);
      font-weight: 500;
      margin-bottom: 4px;
    }

    .media-tile-info p {
      margin: 0;
      font-size: 12px;
      color: var(--text-muted);
    }

    .media-tile-expand {
      color: var(--text-muted);
      transition: var(--transition-fast);
    }

    .media-tile:hover .media-tile-expand {
      color: var(--text-main);
      transform: scale(1.1);
    }

    /* Overlay Panels */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .overlay.active {
      display: flex;
    }

    .overlay-content {
      background: var(--bg-main);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: var(--radius-xl);
      border: 1px solid var(--card-border);
      width: min(800px, 90%);
      height: min(600px, 90%);
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
    }

    .overlay-header {
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .overlay-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text-main);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .overlay-header h3 i {
      width: 20px;
      height: 20px;
      stroke-width: 2;
      color: var(--accent);
    }

    .overlay-close {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
      width: 36px;
      height: 36px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .overlay-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-main);
    }

    .overlay-close i {
      width: 18px;
      height: 18px;
      stroke-width: 2;
    }

    .overlay-body {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    /* Media List Container */
    .media-list-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      min-height: 0;
    }

    .media-list-container::-webkit-scrollbar {
      width: 6px;
    }

    .media-list-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 3px;
    }

    .media-list-container::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 3px;
    }

    .media-list-container::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    /* Media Items */
    .media-item {
      padding: 12px 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: var(--transition-fast);
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .media-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .media-item:last-child {
      border-bottom: none;
    }

    .media-thumbnail {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .media-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .media-thumbnail.audio {
      background: linear-gradient(135deg, rgba(58, 111, 240, 0.2), rgba(58, 111, 240, 0.1));
    }

    .media-thumbnail.audio i {
      width: 18px;
      height: 18px;
      color: var(--accent);
    }

    .media-info {
      flex: 1;
      min-width: 0;
    }

    .media-name {
      color: var(--text-main);
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .media-time {
      color: var(--text-muted);
      font-size: 11px;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
    }

    .media-action {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition-fast);
      flex-shrink: 0;
    }

    .media-action:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: scale(1.05);
    }

    .media-action i {
      width: 14px;
      height: 14px;
      stroke-width: 2;
      color: var(--text-main);
    }

    .no-media {
      text-align: center;
      color: var(--text-muted);
      padding: 40px 20px;
      font-size: 13px;
      font-style: italic;
    }

    /* Media Pagination */
    .media-pagination {
      padding: 16px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .pagination-btn {
      padding: 8px 14px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-main);
      border-radius: var(--radius);
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .pagination-btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    .pagination-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .pagination-info {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Logs Panel - Integrated inside main card */
    .logs-column {
      display: none;
      flex-direction: column;
      gap: 16px;
      opacity: 0;
      transform: translateX(20px);
      transition: opacity 0.35s ease, transform 0.35s ease;
      width: 420px;
      height: 100%;
      min-height: 0;
    }

    .glass-card.with-logs .logs-column {
      display: flex;
      opacity: 1;
      transform: translateX(0);
    }

    .logs-panel {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      border: 1px solid var(--card-border);
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
    }

    .logs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      flex-shrink: 0;
    }

    .logs-header h3 {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
    }

    .logs-close-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 6px;
      border-radius: var(--radius);
      transition: var(--transition-fast);
    }

    .logs-close-btn:hover {
      background: rgba(255,255,255,0.08);
      color: var(--text-main);
    }

    .logs-close-btn i {
      width: 18px;
      height: 18px;
    }

    /* Logs Tabs */
    .logs-tabs {
      display: flex;
      margin-bottom: 16px;
      gap: 4px;
      flex-shrink: 0;
    }

    .logs-tab {
      flex: 1;
      padding: 10px 0;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      text-align: center;
      position: relative;
      transition: var(--transition-fast);
      border-radius: var(--radius);
    }

    .logs-tab:hover {
      color: var(--text-main);
      background: rgba(255, 255, 255, 0.05);
    }

    .logs-tab.active {
      color: var(--accent);
      font-weight: 600;
    }

    .logs-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
      border-radius: 1px;
    }

    /* Logs Content */
    .logs-content {
      flex: 1;
      overflow-y: auto;
      position: relative;
      border-radius: var(--radius);
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.06);
      min-height: 0;
    }

    /* Custom scrollbar for logs */
    .logs-content::-webkit-scrollbar {
      width: 5px;
    }

    .logs-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 3px;
    }

    .logs-content::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 3px;
      transition: var(--transition-fast);
    }

    .logs-content::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .logs-list {
      padding: 16px;
      min-height: 100%;
    }

    .log-item {
      padding: 12px 14px;
      border-radius: var(--radius);
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      margin-bottom: 8px;
      transition: var(--transition-fast);
    }

    .log-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .log-item:last-child {
      margin-bottom: 0;
    }

    .log-time {
      color: var(--text-main);
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .log-coords {
      color: var(--text-muted);
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      font-size: 12px;
      margin-bottom: 4px;
      line-height: 1.4;
    }

    .log-meta {
      color: var(--text-muted);
      font-size: 11px;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      opacity: 0.8;
    }

    .no-logs {
      text-align: center;
      color: var(--text-muted);
      padding: 40px 20px;
      font-size: 13px;
    }

    /* New Log Indicator */
    .new-log-indicator {
      position: sticky;
      bottom: 12px;
      left: 0;
      right: 0;
      margin: 6px 12px;
      padding: 8px 14px;
      background: rgba(58, 111, 240, 0.2);
      border: 1px solid rgba(58, 111, 240, 0.3);
      color: var(--text-main);
      border-radius: var(--radius);
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-fast);
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .new-log-indicator:hover {
      background: rgba(58, 111, 240, 0.3);
      border-color: rgba(58, 111, 240, 0.4);
      transform: translateY(-1px);
    }

    /* Pagination */
    .logs-pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 16px;
      margin-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.06);
      flex-shrink: 0;
    }

    .logs-pagination .pagination-btn {
      padding: 8px 14px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      color: var(--text-main);
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .logs-pagination .pagination-btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    .logs-pagination .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .logs-pagination .pagination-info {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Bottom Row */
    .bottom-row{
      padding: 14px 24px;
      display: flex;
      gap: 24px;
      align-items: center;
      justify-content: space-between;
      border-top: 1px solid rgba(255,255,255,0.06);
      color: var(--text-muted);
      font-size: 12px;
      background: rgba(0, 0, 0, 0.2);
      flex-shrink: 0;
    }

    .bottom-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .bottom-item strong {
      color: var(--text-main);
      font-weight: 600;
    }

    /* Custom Modern Map Marker */
    .modern-marker {
      position: relative;
      width: 34px;
      height: 44px;
      cursor: pointer;
      transition: all 0.3s ease;
      filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.5));
    }

    .modern-marker .pin-body {
      position: absolute;
      width: 34px;
      height: 34px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      top: 6px;
      left: 0;
      box-shadow: 
        inset 0 0 0 2px rgba(255, 255, 255, 0.8),
        0 0 0 3px rgba(58, 111, 240, 0.2),
        0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .modern-marker .pin-body::before {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
    }

    .modern-marker .pin-body::after {
      content: '';
      position: absolute;
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 4px var(--accent);
    }

    .modern-marker .pin-pulse {
      position: absolute;
      width: 44px;
      height: 44px;
      background: var(--accent);
      border-radius: 50%;
      top: 0;
      left: -5px;
      opacity: 0.15;
      animation: pulse 2s infinite;
    }

    .modern-marker .pin-stem {
      position: absolute;
      width: 3px;
      height: 12px;
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.4) 100%);
      border-radius: 2px;
      bottom: 0;
      left: 15.5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    @keyframes pulse {
      0% {
        transform: scale(0.8);
        opacity: 0.15;
      }
      50% {
        transform: scale(1);
        opacity: 0.1;
      }
      100% {
        transform: scale(0.8);
        opacity: 0.15;
      }
    }

    .modern-marker:hover {
      transform: translateY(-4px);
      filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.6));
    }

    .modern-marker:hover .pin-body {
      box-shadow: 
        inset 0 0 0 2px rgba(255, 255, 255, 0.9),
        0 0 0 4px rgba(58, 111, 240, 0.3),
        0 6px 16px rgba(0, 0, 0, 0.4);
    }

    /* FULLSCREEN MAP */
    .glass-card.fullscreen-map {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 9999 !important;
      margin: 0 !important;
      border-radius: 0 !important;
      background: #000 !important;
      display: flex !important;
      flex-direction: column !important;
      padding: 0 !important;
      border: none !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      transition: var(--transition);
    }

    .fullscreen-map .dash-header,
    .fullscreen-map .left-col,
    .fullscreen-map .bottom-row,
    .fullscreen-map .media-panel,
    .fullscreen-map .logs-column {
      display: none !important;
    }

    .fullscreen-map .map-card {
      flex: 1;
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
      box-shadow: none !important;
      border-radius: 0 !important;
      background: transparent !important;
    }

    .fullscreen-map .map-frame {
      height: 100vh !important;
      width: 100vw !important;
      border-radius: 0 !important;
      padding: 0 !important;
      border: none !important;
      box-shadow: none !important;
      background: transparent !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
    }

    .fullscreen-map #map {
      height: 100vh !important;
      width: 100vw !important;
      border-radius: 0 !important;
      background: #000 !important;
    }

    .fullscreen-map .map-header,
    .fullscreen-map .map-controls {
      display: none !important;
    }

    /* Exit Fullscreen Button */
    .exit-fullscreen-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10001;
      background: rgba(255, 255, 255, 0.95);
      color: #1a1d28;
      border: none;
      padding: 10px 18px;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      display: none;
      transition: var(--transition-fast);
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: 'Poppins', sans-serif;
      font-size: 13px;
    }

    .exit-fullscreen-btn:hover {
      background: white;
      box-shadow: var(--shadow-lg);
      transform: translateY(-1px);
    }

    .exit-fullscreen-btn i {
      width: 16px;
      height: 16px;
      stroke-width: 2;
    }

    .fullscreen-map .exit-fullscreen-btn {
      display: flex;
    }

    /* Desktop-specific enhancements */
    body::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    body::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }

    body::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
    }

    body::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Responsive adjustments */
    @media (max-width: 1400px) {
      .glass-card {
        width: min(1100px, 100%);
        height: min(750px, calc(100vh - 40px));
      }
      
      .glass-card.with-logs {
        width: min(1400px, 100%);
      }
    }

    @media (max-width: 1200px) {
      .glass-card {
        width: min(1000px, 100%);
        height: min(700px, calc(100vh - 40px));
      }
      
      .glass-card.with-logs {
        width: min(1200px, 100%);
      }
      
      .dash-main {
        grid-template-columns: 250px 1fr;
        gap: 12px;
        padding: 0 20px 12px;
      }
      
      .glass-card.with-logs .dash-main {
        grid-template-columns: 250px 1fr 380px;
      }
      
      .logs-column {
        width: 380px;
      }
    }

    /* Specific adjustments for 1366×768 screens */
    @media (max-height: 768px) and (max-width: 1366px) {
      .glass-card {
        width: min(1100px, 95%);
        height: min(680px, calc(100vh - 15px));
      }
      
      .dash-main {
        grid-template-columns: 250px 1fr;
        gap: 12px;
      }
      
      .glass-card.with-logs .dash-main {
        grid-template-columns: 250px 1fr 380px;
      }
      
      .logs-column {
        width: 380px;
      }
      
      .btn {
        min-width: 110px;
        padding: 8px 12px;
        font-size: 12px;
      }
    }

    /* Specific adjustments for 1440×900 screens */
    @media (max-height: 900px) and (max-width: 1440px) {
      .glass-card {
        width: min(1150px, 95%);
        height: min(720px, calc(100vh - 20px));
      }
      
      .dash-main {
        height: calc(100% - 70px);
      }
      
      .media-panel {
        height: 85px;
        min-height: 75px;
      }
    }

    /* Ensure map area shrinks properly on very small heights */
    @media (max-height: 650px) {
      #map {
        min-height: 180px;
      }
      
      .map-frame {
        padding: 12px;
      }
      
      .media-panel {
        margin-top: 8px;
      }
    }

    /* Fallback for extremely tight spaces */
    @media (max-height: 580px) {
      .glass-card {
        height: auto;
        min-height: 580px;
      }
      
      .dash-main {
        overflow-y: auto;
        height: auto;
        min-height: 450px;
      }
      
      .map-card {
        min-height: 400px;
      }
      
      #map {
        min-height: 160px;
      }
    }

    /* Prevent map from expanding beyond available space */
    .glass-card:not(.with-logs) .dash-main {
      grid-template-rows: 1fr;
    }

    .glass-card:not(.with-logs) .map-card {
      max-height: 100%;
    }
 </style>
</head>
<body>

  <!-- Video Background -->
  <video id="video-bg" autoplay muted loop playsinline>
    <source src="https://assets.codepen.io/3364143/7btrrd.mp4" type="video/mp4">
  </video>
  <div class="video-overlay"></div>

  <!-- MAIN DASHBOARD -->
  <div class="glass-card" id="dashboard">
    <!-- Header with Status Strip -->
    <div class="dash-header">
      <div class="header-content">
        <div class="dash-title">
          <h2>Public Safety System</h2>
        </div>

        <div class="header-actions">
          <button class="icon-btn" title="Share" onclick="shareUrl()">
            <i data-lucide="share"></i>
            <span>Share</span>
          </button>
          <button class="icon-btn" title="Information" onclick="showUserInfo()">
            <i data-lucide="info"></i>
            <span>Info</span>
          </button>
        </div>
      </div>
      <div class="status-strip offline" id="statusStrip"></div>
    </div>

    <!-- Main Content -->
    <div class="dash-main">
      <!-- Left Column -->
      <div class="left-col">
        <!-- Device Card -->
        <div class="card">
          <div class="card-header">
            <i data-lucide="smartphone"></i>
            <h4>Device Information</h4>
          </div>
          <div class="device-info">
            <div class="device-line">
              <div class="device-label">
                <i data-lucide="badge-check"></i>
                <span>Device ID</span>
              </div>
              <div class="device-value" id="deviceId">unavailable</div>
            </div>
            <div class="device-line">
              <div class="device-label">
                <i data-lucide="circle"></i>
                <span>Status</span>
              </div>
              <div class="status-indicator">
                <div class="status-dot offline" id="statusDot"></div>
                <div class="device-value" id="deviceStatus">Offline</div>
              </div>
            </div>
            <div class="device-line">
              <div class="device-label">
                <i data-lucide="battery"></i>
                <span>Battery</span>
              </div>
              <div class="device-value" id="batteryInfo">unavailable</div>
            </div>
          </div>
        </div>

        <!-- Location Card -->
        <div class="card">
          <div class="card-header">
            <i data-lucide="map-pin"></i>
            <h4>Location Details</h4>
          </div>
          <div class="loc-grid">
            <div class="loc-row">
              <div class="loc-label">Last Updated</div>
              <div class="loc-value" id="lastUpdated">unavailable</div>
            </div>
            <div class="loc-row">
              <div class="loc-label">Latitude</div>
              <div class="loc-value" id="latVal">unavailable</div>
            </div>
            <div class="loc-row">
              <div class="loc-label">Longitude</div>
              <div class="loc-value" id="lngVal">unavailable</div>
            </div>
            <div class="loc-row">
              <div class="loc-label">Accuracy</div>
              <div class="loc-value" id="accVal">unavailable</div>
            </div>
            <div class="address-box" id="addrVal">
              <div class="loc-label">Address</div>
              <div style="margin-top: 6px;">unavailable</div>
            </div>
          </div>
        </div>

        <!-- Settings Card -->
        <div class="card">
          <div class="card-header">
            <i data-lucide="settings"></i>
            <h4>Settings</h4>
          </div>
          <div class="device-info">
            <div class="setting-row">
              <div class="setting-label">
                <i data-lucide="navigation"></i>
                <span>Auto Scroll</span>
              </div>
              <div id="autoScrollToggle" class="toggle on" onclick="toggleAutoScroll()">
                <div class="dot"></div>
              </div>
            </div>
            <div class="setting-row">
              <div class="setting-label">
                <i data-lucide="refresh-cw"></i>
                <span>Auto Refresh</span>
              </div>
              <select id="autoRefreshSelect" class="auto-refresh-select" onchange="changeAutoRefresh()">
                <option value="0">Off</option>
                <option value="5000">5 sec</option>
                <option value="10000" selected>10 sec</option>
                <option value="30000">30 sec</option>
                <option value="60000">1 min</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Map Card -->
      <div class="map-card">
        <div class="map-frame">
          <div class="map-header">
            <div class="map-title">
              <i data-lucide="map"></i>
              <span>Live Location Map</span>
            </div>
            <div class="map-provider">OpenStreetMap</div>
          </div>

          <div id="map"></div>

          <div class="map-controls">
            <button id="refreshBtn" class="btn btn-refresh" onclick="refreshNow()">
              <i data-lucide="refresh-cw"></i>
              <span>Refresh</span>
            </button>
            <button id="dirBtn" class="btn btn-directions disabled" onclick="openDirections()">
              <i data-lucide="navigation"></i>
              <span>Directions</span>
            </button>
            <button id="expandBtn" class="btn btn-expand" onclick="enterFullScreenMap()">
              <i data-lucide="maximize-2"></i>
              <span>Expand Map</span>
            </button>
            <button id="logsBtn" class="btn btn-logs" onclick="openLogsPanel()">
              <i data-lucide="list"></i>
              <span>View Logs</span>
            </button>
          </div>
        </div>

        <!-- Compact Media Panel - NEW DESIGN -->
        <div class="media-panel">
          <div class="media-grid">
            <!-- Audio Recordings Tile -->
            <div class="media-tile" onclick="openAudioPanel()">
              <div class="media-tile-content">
                <div class="media-tile-icon">
                  <i data-lucide="play-circle"></i>
                </div>
                <div class="media-tile-info">
                  <h4>Audio Recordings</h4>
                  <p>Click to view and play recordings</p>
                </div>
              </div>
              <div class="media-tile-expand">
                <i data-lucide="maximize-2"></i>
              </div>
            </div>

            <!-- Photos Tile -->
            <div class="media-tile" onclick="openPhotoPanel()">
              <div class="media-tile-content">
                <div class="media-tile-icon">
                  <i data-lucide="image"></i>
                </div>
                <div class="media-tile-info">
                  <h4>Photos</h4>
                  <p>Click to view photos</p>
                </div>
              </div>
              <div class="media-tile-expand">
                <i data-lucide="maximize-2"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Logs Column (Hidden by default) -->
      <div class="logs-column">
        <div class="logs-panel">
          <div class="logs-header">
            <h3>Location History</h3>
            <button class="logs-close-btn" onclick="closeLogsPanel()">
              <i data-lucide="x"></i>
            </button>
          </div>

          <div class="logs-tabs">
            <button class="logs-tab active" onclick="switchLogsMode('realtime')">
              Realtime Logs
            </button>
            <button class="logs-tab" onclick="switchLogsMode('full')">
              Full Log List
            </button>
          </div>

          <div class="logs-content">
            <div class="logs-list" id="logsList">
              <div class="no-logs">Loading logs...</div>
            </div>
          </div>

          <div class="logs-pagination" id="logsPagination" style="display: none;">
            <button class="pagination-btn" id="prevBtn" onclick="changeLogsPage(-1)">
              Previous
            </button>
            <div class="pagination-info" id="pageInfo">Page 1 of 1</div>
            <button class="pagination-btn" id="nextBtn" onclick="changeLogsPage(1)">
              Next
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Row -->
    <div class="bottom-row">
      <div class="bottom-item">
        <strong>User ID:</strong> <span id="bottomUser">unavailable</span>
      </div>
      <div class="bottom-item">
        <strong>Device:</strong> <span id="bottomDevice">unavailable</span>
      </div>
      <div class="bottom-item">
        <strong>Version:</strong> v2.1 Desktop
      </div>
    </div>
  </div>

  <!-- Audio Overlay Panel -->
  <div class="overlay" id="audioOverlay">
    <div class="overlay-content">
      <div class="overlay-header">
        <h3><i data-lucide="play-circle"></i> Audio Recordings</h3>
        <button class="overlay-close" onclick="closeAudioPanel()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="overlay-body">
        <div class="media-list-container" id="audioListContainer">
          <div class="no-media">Loading audio...</div>
        </div>
        <div class="media-pagination" id="audioPagination" style="display: none;">
          <button class="pagination-btn" id="audioPrevBtn" onclick="changeAudioPage(-1)">
            Previous
          </button>
          <div class="pagination-info" id="audioPageInfo">Page 1 of 1</div>
          <button class="pagination-btn" id="audioNextBtn" onclick="changeAudioPage(1)">
            Next
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Photos Overlay Panel -->
  <div class="overlay" id="photoOverlay">
    <div class="overlay-content">
      <div class="overlay-header">
        <h3><i data-lucide="image"></i> Photos</h3>
        <button class="overlay-close" onclick="closePhotoPanel()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="overlay-body">
        <div class="media-list-container" id="photoListContainer">
          <div class="no-media">Loading photos...</div>
        </div>
        <div class="media-pagination" id="photoPagination" style="display: none;">
          <button class="pagination-btn" id="photoPrevBtn" onclick="changePhotoPage(-1)">
            Previous
          </button>
          <div class="pagination-info" id="photoPageInfo">Page 1 of 1</div>
          <button class="pagination-btn" id="photoNextBtn" onclick="changePhotoPage(1)">
            Next
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- EXIT FULLSCREEN BUTTON (Hidden by default) -->
  <button class="exit-fullscreen-btn" id="exitFullscreenBtn" onclick="exitFullScreenMap()">
    <i data-lucide="minimize-2"></i>
    Exit Full Screen
  </button>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /**************** REDIRECT SYSTEM *****************/
    const API_URL = 'https://jwki58wsv8.execute-api.ap-south-1.amazonaws.com/prod/location';
    const HISTORY_API_URL = 'https://jwki58wsv8.execute-api.ap-south-1.amazonaws.com/prod/location/history';
    const PHOTOS_API_URL = 'https://jwki58wsv8.execute-api.ap-south-1.amazonaws.com/prod/media/photos';
    const AUDIO_API_URL = 'https://jwki58wsv8.execute-api.ap-south-1.amazonaws.com/prod/media/audio';
    const WORKER_URL = 'https://track.themidb.workers.dev';

    // Check if device is mobile
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Get URL parameters
    function getUrlParams(){
      return Object.fromEntries(new URLSearchParams(window.location.search).entries());
    }
    
    function getUserId(){
      const p = getUrlParams();
      return p.userId || p.userid || p.id || null;
    }

    // Redirect to worker URL
    function redirectToWorker(userId = null) {
      const url = userId ? `${WORKER_URL}?userId=${encodeURIComponent(userId)}` : WORKER_URL;
      window.location.href = url;
    }

    // Check API response for invalid user
async function verifyUserId(userId) {
  try {
    const response = await fetch(`${API_URL}?userId=${encodeURIComponent(userId)}`);
    const json = await response.json();

    let payload;
    if (json && typeof json === 'object' && json.body) {
      try {
        payload = typeof json.body === 'string' ? JSON.parse(json.body) : json.body;
      } catch (e) {
        payload = json.body;
      }
    } else {
      payload = json;
    }

    // Only invalid if API explicitly says so
    if (payload.status === false || payload.success === false || payload.error) {
      return false;
    }

    // VALID even if payload.data is missing
    return true;

  } catch (err) {
    console.error('Verification failed:', err);


    return false;
  }
}

    // Initial verification and redirect logic
async function initVerification() {
  const userId = getUserId();

  // Rule 1 → Mobile device always goes to worker
  if (isMobileDevice()) {
    redirectToWorker(userId);
    return false;
  }

  // Rule 2 → Missing userId → redirect
  if (!userId) {
    redirectToWorker();
    return false;
  }

  // Rule 3 → Invalid ID → redirect WITH the same ID
  const isValid = await verifyUserId(userId);
  if (!isValid) {
    redirectToWorker();
    return false;
  }

  // Only valid desktop users load dashboard
  return true;
}

    /**************** DASHBOARD FUNCTIONALITY *****************/
    let autoRefreshIntervalMs = 10000; // Default to 10 seconds
    let autoRefreshTimer = null;
    const UNAVAIL = 'unavailable';

    /**************** STATE *****************/
    let map, marker, accuracyCircle;
    let currentLat=null, currentLng=null;
    let isAutoScroll = true; // Default ON
    let isUserPanning = false;
    
    // Logs state
    let currentLogsPage = 1;
    let totalLogsPages = 1;
    let currentLogsMode = 'realtime';
    let realtimeLogsInterval = null;
    let realtimeLogsList = [];
    let lastRealtimeLogKey = null;
    let userScrolledUp = false;
    let newLogsAvailable = false;

    // Media state
    let currentAudioPage = 1;
    let totalAudioPages = 1;
    let currentPhotoPage = 1;
    let totalPhotoPages = 1;

    /**************** HELPERS *****************/
    function setText(id, value){
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = (value === undefined || value === null || value === '') ? UNAVAIL : value;
    }
    
    function setStatus(status) {
      const statusStrip = document.getElementById('statusStrip');
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('deviceStatus');
      
      statusStrip.classList.remove('online', 'fetching', 'offline');
      statusDot.classList.remove('online', 'fetching', 'offline');
      
      statusStrip.classList.add(status);
      statusDot.classList.add(status);
      
      const statusMap = {
        online: 'Online',
        fetching: 'Fetching...',
        offline: 'Offline'
      };
      statusText.textContent = statusMap[status];
    }
    
    function setAttrDisabled(el, disabled){
      if(!el) return;
      if(disabled) {
        el.classList.add('disabled');
        el.disabled = true;
      } else {
        el.classList.remove('disabled');
        el.disabled = false;
      }
    }

    /**************** SHARE FUNCTIONALITY *****************/
    function shareUrl(){
      const currentUrl = window.location.href;
      if (navigator.share) {
        navigator.share({
          title: 'Public Safety System - Desktop',
          text: 'Check out this public safety system desktop tracking dashboard',
          url: currentUrl
        })
        .catch(err => {
          fallbackShare(currentUrl);
        });
      } else {
        fallbackShare(currentUrl);
      }
    }

    function fallbackShare(url) {
      navigator.clipboard.writeText(url).then(() => {
        alert('URL copied to clipboard: ' + url);
      }).catch(err => {
        prompt('Copy this URL to share:', url);
      });
    }

    /**************** MAP INIT *****************/
    function initMap(){
      if(map) return; 

      map = L.map('map', { 
        zoomControl: true,
        scrollWheelZoom: true,
        zoomSnap: 0.1,
        zoomDelta: 0.5
      }).setView([20.5937,78.9629], 5);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      const ModernMarkerIcon = L.divIcon({
        className: 'modern-marker',
        html: `
          <div class="modern-marker">
            <div class="pin-pulse"></div>
            <div class="pin-body"></div>
            <div class="pin-stem"></div>
          </div>
        `,
        iconSize: [34, 44],
        iconAnchor: [17, 44],
        popupAnchor: [0, -44]
      });

      marker = L.marker([20.5937,78.9629], { icon: ModernMarkerIcon }).addTo(map);
      accuracyCircle = L.circle([20.5937,78.9629], {
        radius: 0, 
        color: '#3a6df0', 
        opacity: 0.3, 
        fillOpacity: 0.15,
        weight: 2
      }).addTo(map);

      map.on('dragstart', function() {
        if (isAutoScroll) {
          isUserPanning = true;
        }
      });

      map.on('dragend', function() {
        if (isAutoScroll && isUserPanning && currentLat && currentLng) {
          map.flyTo([currentLat, currentLng], map.getZoom(), { 
            duration: 0.8,
            easeLinearity: 0.3
          });
          isUserPanning = false;
        }
      });

      map.on('moveend', function() {
        if (isAutoScroll && isUserPanning && currentLat && currentLng) {
          map.flyTo([currentLat, currentLng], map.getZoom(), { 
            duration: 0.8,
            easeLinearity: 0.3
          });
          isUserPanning = false;
        }
      });
    }

    /**************** OVERLAY PANEL FUNCTIONS *****************/
    function openAudioPanel() {
      document.getElementById('audioOverlay').classList.add('active');
      fetchAudio();
    }

    function closeAudioPanel() {
      document.getElementById('audioOverlay').classList.remove('active');
    }

    function openPhotoPanel() {
      document.getElementById('photoOverlay').classList.add('active');
      fetchPhotos();
    }

    function closePhotoPanel() {
      document.getElementById('photoOverlay').classList.remove('active');
    }

    /**************** LOGS PANEL FUNCTIONS *****************/
    function openLogsPanel() {
      const dashboard = document.getElementById('dashboard');
      dashboard.classList.add('with-logs');
      
      setTimeout(() => {
        if (map) map.invalidateSize();
      }, 350);
      
      fetchLogs();
      
      if (currentLogsMode === 'realtime') {
        startRealtimePolling();
      }
      
      const logsContent = document.querySelector('.logs-content');
      if (logsContent) {
        logsContent.addEventListener('scroll', handleLogsScroll);
      }
    }

    function closeLogsPanel() {
      const dashboard = document.getElementById('dashboard');
      dashboard.classList.remove('with-logs');
      
      setTimeout(() => {
        if (map) map.invalidateSize();
      }, 350);
      
      stopRealtimePolling();
      
      const logsContent = document.querySelector('.logs-content');
      if (logsContent) {
        logsContent.removeEventListener('scroll', handleLogsScroll);
      }
    }

    function switchLogsMode(mode) {
      currentLogsMode = mode;
      currentLogsPage = 1;
      
      document.querySelectorAll('.logs-tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent.includes(mode === 'realtime' ? 'Realtime Logs' : 'Full Log List'));
      });
      
      document.getElementById('logsPagination').style.display = mode === 'full' ? 'flex' : 'none';
      
      if (mode === 'realtime') {
        startRealtimePolling();
        realtimeLogsList = [];
        lastRealtimeLogKey = null;
        userScrolledUp = false;
        newLogsAvailable = false;
      } else {
        stopRealtimePolling();
      }
      
      fetchLogs();
    }

    function startRealtimePolling() {
      stopRealtimePolling();
      realtimeLogsInterval = setInterval(() => {
        fetchLatestLog();
      }, 5000);
    }

    function stopRealtimePolling() {
      if (realtimeLogsInterval) {
        clearInterval(realtimeLogsInterval);
        realtimeLogsInterval = null;
      }
    }

    function handleLogsScroll() {
      const logsContent = document.querySelector('.logs-content');
      const scrollTop = logsContent.scrollTop;
      const scrollHeight = logsContent.scrollHeight;
      const clientHeight = logsContent.clientHeight;
      
      const isNearBottom = (scrollHeight - scrollTop - clientHeight) < 100;
      
      if (isNearBottom) {
        userScrolledUp = false;
        hideNewLogIndicator();
      } else {
        userScrolledUp = true;
      }
    }

    function showNewLogIndicator() {
      let indicator = document.querySelector('.new-log-indicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.className = 'new-log-indicator';
        indicator.innerHTML = '<i data-lucide="arrow-down"></i> New log available';
        indicator.onclick = scrollToBottom;
        document.querySelector('.logs-content').appendChild(indicator);
        lucide.createIcons();
      }
      indicator.style.display = 'block';
      newLogsAvailable = true;
    }

    function hideNewLogIndicator() {
      const indicator = document.querySelector('.new-log-indicator');
      if (indicator) {
        indicator.style.display = 'none';
        newLogsAvailable = false;
      }
    }

    function scrollToBottom() {
      const logsContent = document.querySelector('.logs-content');
      logsContent.scrollTo({
        top: logsContent.scrollHeight,
        behavior: 'smooth'
      });
      hideNewLogIndicator();
      userScrolledUp = false;
    }

    async function fetchLatestLog() {
      const uid = getUserId();
      if (!uid) return;

      try {
        const response = await fetch(`${HISTORY_API_URL}?userId=${encodeURIComponent(uid)}&page=1&pageSize=1`);
        const data = await response.json();

        let payload;
        if (data && typeof data === "object" && data.body) {
          try {
            payload = typeof data.body === "string" ? JSON.parse(data.body) : data.body;
          } catch (e) {
            payload = data.body;
          }
        } else payload = data;

        if (payload.success === false || !payload.logs || payload.logs.length === 0) {
          return;
        }

        const latestLog = payload.logs[0];
        const logKey = `${latestLog.loggedAt}_${latestLog.lat}_${latestLog.lng}`;
        
        if (logKey !== lastRealtimeLogKey) {
          lastRealtimeLogKey = logKey;
          realtimeLogsList.unshift(latestLog);
          
          if (realtimeLogsList.length > 50) {
            realtimeLogsList.pop();
          }
          
          renderRealtimeLogs();
          
          if (userScrolledUp) {
            showNewLogIndicator();
          } else {
            setTimeout(scrollToBottom, 100);
          }
        }
      } catch (error) {
        console.error('Error fetching latest log:', error);
      }
    }

    function renderRealtimeLogs() {
      const logsList = document.getElementById('logsList');
      
      if (realtimeLogsList.length === 0) {
        logsList.innerHTML = '<div class="no-logs">Waiting for logs...</div>';
        return;
      }

      let logsHTML = '';
      [...realtimeLogsList].reverse().forEach(log => {
        const time = log.timestamp || new Date(log.loggedAt).toLocaleTimeString();
        const loggedAt = log.loggedAt ? new Date(log.loggedAt).toLocaleString() : 'Unknown';
        const lat = log.lat ? parseFloat(log.lat).toFixed(6) : '–';
        const lng = log.lng ? parseFloat(log.lng).toFixed(6) : '–';
        
        logsHTML += `
          <div class="log-item">
            <div class="log-time">
              <span>${time}</span>
              <i data-lucide="circle" style="width: 8px; height: 8px; color: var(--accent);"></i>
            </div>
            <div class="log-coords">Lat: ${lat}, Lng: ${lng}</div>
            <div class="log-meta">${loggedAt}</div>
          </div>
        `;
      });
      
      logsList.innerHTML = logsHTML;
      lucide.createIcons();
    }

    async function fetchLogs() {
      const uid = getUserId();
      if (!uid) return;

      const logsList = document.getElementById('logsList');
      
      try {
        if (currentLogsMode === 'realtime') {
          const response = await fetch(`${HISTORY_API_URL}?userId=${encodeURIComponent(uid)}&page=1&pageSize=1`);
          const data = await response.json();

          let payload;
          if (data && typeof data === "object" && data.body) {
            try {
              payload = typeof data.body === "string" ? JSON.parse(data.body) : data.body;
            } catch (e) {
              payload = data.body;
            }
          } else payload = data;

          if (payload.success === false || !payload.logs || payload.logs.length === 0) {
            logsList.innerHTML = '<div class="no-logs">No logs yet for this user</div>';
            return;
          }

          const latestLog = payload.logs[0];
          lastRealtimeLogKey = `${latestLog.loggedAt}_${latestLog.lat}_${latestLog.lng}`;
          realtimeLogsList = [latestLog];
          
          renderRealtimeLogs();
          setTimeout(scrollToBottom, 100);
          
        } else {
          const response = await fetch(`${HISTORY_API_URL}?userId=${encodeURIComponent(uid)}&page=${currentLogsPage}&pageSize=20`);
          const data = await response.json();

          let payload;
          if (data && typeof data === "object" && data.body) {
            try {
              payload = typeof data.body === "string" ? JSON.parse(data.body) : data.body;
            } catch (e) {
              payload = data.body;
            }
          } else payload = data;

          if (payload.success === false || !payload.logs) {
            logsList.innerHTML = '<div class="no-logs">No logs available</div>';
            return;
          }

          const logs = payload.logs || [];
          totalLogsPages = payload.totalPages || 1;

          document.getElementById("pageInfo").textContent = `Page ${currentLogsPage} of ${totalLogsPages}`;
          document.getElementById("prevBtn").disabled = currentLogsPage <= 1;
          document.getElementById("nextBtn").disabled = currentLogsPage >= totalLogsPages || logs.length === 0;

          if (logs.length === 0) {
            logsList.innerHTML = '<div class="no-logs">No logs on this page</div>';
            return;
          }

          let logsHTML = '';
          logs.forEach(log => {
            const time = log.timestamp || 'Unknown time';
            const loggedAt = log.loggedAt ? new Date(log.loggedAt).toLocaleString() : 'Unknown';
            const lat = log.lat ? parseFloat(log.lat).toFixed(6) : '–';
            const lng = log.lng ? parseFloat(log.lng).toFixed(6) : '–';
            
            logsHTML += `
              <div class="log-item">
                <div class="log-time">${time}</div>
                <div class="log-coords">Lat: ${lat}, Lng: ${lng}</div>
                <div class="log-meta">${loggedAt}</div>
            </div>
            `;
          });
          
          logsList.innerHTML = logsHTML;
        }
      } catch (error) {
        console.error('Error fetching logs:', error);
        document.getElementById('logsList').innerHTML = '<div class="no-logs">Error loading logs</div>';
      }
    }

    function changeLogsPage(direction) {
      const newPage = currentLogsPage + direction;
      if (newPage >= 1 && newPage <= totalLogsPages) {
        currentLogsPage = newPage;
        fetchLogs();
      }
    }

    /**************** MEDIA FUNCTIONS *****************/
    async function fetchAudio() {
      const uid = getUserId();
      if (!uid) return;

      try {
        const response = await fetch(`${AUDIO_API_URL}?userId=${encodeURIComponent(uid)}&page=${currentAudioPage}&pageSize=10`);
        const data = await response.json();

        let payload;
        if (data && typeof data === "object" && data.body) {
          try {
            payload = typeof data.body === "string" ? JSON.parse(data.body) : data.body;
          } catch (e) {
            payload = data.body;
          }
        } else payload = data;

        const audioList = document.getElementById('audioListContainer');
        
        if (payload.success === false || !payload.audio || payload.audio.length === 0) {
          audioList.innerHTML = '<div class="no-media">No recordings yet</div>';
          document.getElementById('audioPagination').style.display = 'none';
          return;
        }

        const audioItems = payload.audio || [];
        totalAudioPages = payload.totalPages || 1;

        document.getElementById("audioPageInfo").textContent = `Page ${currentAudioPage} of ${totalAudioPages}`;
        document.getElementById("audioPrevBtn").disabled = currentAudioPage <= 1;
        document.getElementById("audioNextBtn").disabled = currentAudioPage >= totalAudioPages;
        document.getElementById('audioPagination').style.display = totalAudioPages > 1 ? 'flex' : 'none';

        let audioHTML = '';
        audioItems.forEach(audio => {
          const fileName = audio.fileKey ? audio.fileKey.split('/').pop() : 'Recording';
          const time = audio.loggedAt ? new Date(audio.loggedAt).toLocaleString() : 'Unknown time';
          
          audioHTML += `
            <div class="media-item" onclick="playAudio('${audio.playUrl}')">
              <div class="media-thumbnail audio">
                <i data-lucide="volume-2"></i>
              </div>
              <div class="media-info">
                <div class="media-name">${fileName}</div>
                <div class="media-time">${time}</div>
              </div>
              <div class="media-action">
                <i data-lucide="play"></i>
              </div>
            </div>
          `;
        });
        
        audioList.innerHTML = audioHTML;
        lucide.createIcons();
        
      } catch (error) {
        console.error('Error fetching audio:', error);
        document.getElementById('audioListContainer').innerHTML = '<div class="no-media">Error loading recordings</div>';
      }
    }

    async function fetchPhotos() {
      const uid = getUserId();
      if (!uid) return;

      try {
        const response = await fetch(`${PHOTOS_API_URL}?userId=${encodeURIComponent(uid)}&page=${currentPhotoPage}&pageSize=10`);
        const data = await response.json();

        let payload;
        if (data && typeof data === "object" && data.body) {
          try {
            payload = typeof data.body === "string" ? JSON.parse(data.body) : data.body;
          } catch (e) {
            payload = data.body;
          }
        } else payload = data;

        const photoList = document.getElementById('photoListContainer');
        
        if (payload.success === false || !payload.photos || payload.photos.length === 0) {
          photoList.innerHTML = '<div class="no-media">No photos yet</div>';
          document.getElementById('photoPagination').style.display = 'none';
          return;
        }

        const photoItems = payload.photos || [];
        totalPhotoPages = payload.totalPages || 1;

        document.getElementById("photoPageInfo").textContent = `Page ${currentPhotoPage} of ${totalPhotoPages}`;
        document.getElementById("photoPrevBtn").disabled = currentPhotoPage <= 1;
        document.getElementById("photoNextBtn").disabled = currentPhotoPage >= totalPhotoPages;
        document.getElementById('photoPagination').style.display = totalPhotoPages > 1 ? 'flex' : 'none';

        let photoHTML = '';
        photoItems.forEach(photo => {
          const fileName = photo.fileKey ? photo.fileKey.split('/').pop() : 'Photo';
          const time = photo.loggedAt ? new Date(photo.loggedAt).toLocaleString() : 'Unknown time';
          
          photoHTML += `
            <div class="media-item" onclick="viewPhoto('${photo.viewUrl}')">
              <div class="media-thumbnail">
                <img src="${photo.viewUrl}" alt="${fileName}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i data-lucide=\\'image\\'></i>'; lucide.createIcons();">
              </div>
              <div class="media-info">
                <div class="media-name">${fileName}</div>
                <div class="media-time">${time}</div>
              </div>
              <div class="media-action">
                <i data-lucide="download"></i>
              </div>
            </div>
          `;
        });
        
        photoList.innerHTML = photoHTML;
        lucide.createIcons();
        
      } catch (error) {
        console.error('Error fetching photos:', error);
        document.getElementById('photoListContainer').innerHTML = '<div class="no-media">Error loading photos</div>';
      }
    }

    function changeAudioPage(direction) {
      const newPage = currentAudioPage + direction;
      if (newPage >= 1 && newPage <= totalAudioPages) {
        currentAudioPage = newPage;
        fetchAudio();
      }
    }

    function changePhotoPage(direction) {
      const newPage = currentPhotoPage + direction;
      if (newPage >= 1 && newPage <= totalPhotoPages) {
        currentPhotoPage = newPage;
        fetchPhotos();
      }
    }

    function playAudio(url) {
      if (!url) return;
      const audio = new Audio(url);
      audio.play().catch(e => {
        console.error('Error playing audio:', e);
        alert('Unable to play audio. Please try again.');
      });
    }

    function viewPhoto(url) {
      if (!url) return;
      window.open(url, '_blank', 'width=800,height=600');
    }

    /**************** FULL SCREEN MAP FUNCTIONS *****************/
    function enterFullScreenMap() {
      const dashboard = document.getElementById('dashboard');
      const exitBtn = document.getElementById('exitFullscreenBtn');
      
      dashboard.classList.add('fullscreen-map');
      exitBtn.style.display = 'flex';
      
      setTimeout(() => {
        if (map) map.invalidateSize();
      }, 350);
    }

    function exitFullScreenMap() {
      const dashboard = document.getElementById('dashboard');
      const exitBtn = document.getElementById('exitFullscreenBtn');
      
      dashboard.classList.remove('fullscreen-map');
      exitBtn.style.display = 'none';
      
      setTimeout(() => {
        if (map) map.invalidateSize();
      }, 350);
    }

    /**************** DASHBOARD INIT *****************/
    function initDashboard(){
      const userId = getUserId();
      if(userId){
        document.getElementById('bottomUser').textContent = userId;
        document.getElementById('deviceId').textContent = userId;
        fetchAndApply();
      } else {
        applyUnavailableUI();
      }

      document.getElementById('autoRefreshSelect').value = '10000';
      
      if(!autoRefreshTimer) {
         autoRefreshTimer = setInterval(()=>{ fetchAndApply(); }, autoRefreshIntervalMs);
      }

      lucide.createIcons();
      
      document.getElementById('exitFullscreenBtn').style.display = 'none';
      
      setTimeout(() => {
        if (map) map.invalidateSize();
      }, 500);
    }

    /**************** FETCH API *****************/
    async function fetchAndApply(){
      const userId = getUserId();
      if(!userId){
        applyUnavailableUI();
        return;
      }

      setStatus('fetching');
      setText('lastUpdated', 'Fetching...');

      try{
        const resp = await fetch(`${API_URL}?userId=${encodeURIComponent(userId)}`);
        const j = await resp.json();

        let payload;
        if(j && typeof j === 'object' && j.body){
          try{ payload = typeof j.body === 'string' ? JSON.parse(j.body) : j.body; } catch(e){ payload = j.body; }
        } else payload = j;

        if(payload.success === false || payload.error){
              applyUnavailableUI(payload);
              return;
        }

        let data = payload && payload.data ? payload.data : payload;

        if(!data || Object.keys(data).length===0){
          applyUnavailableUI();
          return;
        }

        const apiTimestamp = data.timestamp ?? data.time ?? data.ts ?? null;

        const lat = parseFloat(data.latitude ?? data.lat ?? NaN);
        const lng = parseFloat(data.longitude ?? data.lon ?? data.lng ?? NaN);

        if(!isFinite(lat) || !isFinite(lng)){
          applyUnavailableUI(data);
          return;
        }

        setStatus('online');

        currentLat = lat; 
        currentLng = lng;

        marker.setLatLng([lat,lng]);
        const acc = (data.accuracy !== undefined && data.accuracy !== null) ? Number(data.accuracy) : 0;
        accuracyCircle.setLatLng([lat,lng]);
        accuracyCircle.setRadius(acc || 0);

        if(isAutoScroll && !isUserPanning){
          map.flyTo([lat, lng], 15, { 
            duration: 0.8,
            easeLinearity: 0.3
          });
        }

        marker.bindPopup(`
          <div style="padding: 10px; font-size: 13px;">
            <strong>User:</strong> ${userId}<br>
            <strong>Location:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
            <strong>Time:</strong> ${apiTimestamp ? new Date(apiTimestamp).toLocaleString() : new Date().toLocaleString()}
          </div>
        `).openPopup();

        setText('deviceId', data.userId ?? userId);
        setText('bottomUser', data.userId ?? userId);
        setText('bottomDevice', data.device ?? UNAVAIL);
        
        const battLevel = data.batteryPercentage ?? data.battery;
        const isCharging = data.isCharging ?? data.charging;

        if (battLevel !== undefined && battLevel !== null) {
          const chargeStatus = isCharging ? '⚡ (Charging)' : '';
          setText('batteryInfo', `${battLevel}% ${chargeStatus}`);
        } else {
          setText('batteryInfo', UNAVAIL);
        }

        setText('latVal', lat.toFixed(6));
        setText('lngVal', lng.toFixed(6));
        setText('accVal', data.accuracy ? `${Math.round(data.accuracy)} meters` : UNAVAIL);

        const addrVal = document.getElementById('addrVal');
        if(data.address) {
          addrVal.innerHTML = `
            <div class="loc-label">Address</div>
            <div style="margin-top: 6px;">${data.address}</div>
          `;
        } else {
          fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
            .then(r=>r.json())
            .then(d=>{
              const disp = d && d.display_name ? d.display_name : UNAVAIL;
              addrVal.innerHTML = `
                <div class="loc-label">Address</div>
                <div style="margin-top: 6px;">${disp}</div>
              `;
            }).catch(err=>{
              addrVal.innerHTML = `
                <div class="loc-label">Address</div>
                <div style="margin-top: 6px;">${UNAVAIL}</div>
              `;
            });
        }

        if(apiTimestamp){
          const parsed = new Date(apiTimestamp);
          if(!isNaN(parsed.getTime())) {
            setText('lastUpdated', parsed.toLocaleString());
          } else {
            setText('lastUpdated', apiTimestamp);
          }
        } else {
          setText('lastUpdated', new Date().toLocaleString());
        }

        setText('bottomDevice', data.device ?? UNAVAIL);

        setAttrDisabled(document.getElementById('dirBtn'), false);

      } catch(err){
        console.error('Fetch error', err);
        applyUnavailableUI();
      }
    }

    /**************** APPLY UNAVAILABLE UI *****************/
    function applyUnavailableUI(data){
      const uid = getUserId();
      setText('deviceId', data && data.userId ? data.userId : (uid || UNAVAIL));
      setText('bottomUser', data && data.userId ? data.userId : (uid || UNAVAIL));
      
      setStatus('offline');

      const batt = data ? (data.batteryPercentage ?? data.battery) : null;
      setText('batteryInfo', batt !== null ? `${batt}%` : UNAVAIL);

      setText('latVal', UNAVAIL);
      setText('lngVal', UNAVAIL);
      setText('accVal', UNAVAIL);
      
      const addrVal = document.getElementById('addrVal');
      addrVal.innerHTML = `
        <div class="loc-label">Address</div>
        <div style="margin-top: 6px;">${UNAVAIL}</div>
      `;
      
      setText('lastUpdated', UNAVAIL);
      setText('bottomDevice', data && data.device ? data.device : UNAVAIL);

      setAttrDisabled(document.getElementById('dirBtn'), true);
    }

    /**************** BUTTONS *****************/
    function refreshNow(){
      fetchAndApply();
    }

    function openDirections(){
      if(!currentLat || !currentLng){
        alert('Coordinates not available');
        return;
      }
      const url = `https://www.google.com/maps/dir/?api=1&destination=${currentLat},${currentLng}&travelmode=driving`;
      window.open(url, '_blank', 'width=1200,height=800');
    }

    /**************** SETTINGS UI *****************/
    function toggleAutoScroll(){
      isAutoScroll = !isAutoScroll;
      const el = document.getElementById('autoScrollToggle');
      if(isAutoScroll) {
        el.classList.add('on');
        if(currentLat && currentLng){
          map.flyTo([currentLat, currentLng], map.getZoom(), { 
            duration: 0.8,
            easeLinearity: 0.3
          });
        }
      } else {
        el.classList.remove('on');
      }
    }

    function changeAutoRefresh(){
      const val = Number(document.getElementById('autoRefreshSelect').value);
      autoRefreshIntervalMs = val;
      if(autoRefreshTimer) { 
        clearInterval(autoRefreshTimer); 
        autoRefreshTimer = null; 
      }
      if(autoRefreshIntervalMs > 0){
        autoRefreshTimer = setInterval(()=>{ fetchAndApply(); }, autoRefreshIntervalMs);
      }
    }

    /**************** USER INFO *****************/
    function showUserInfo() {
      const userId = getUserId();
      alert(`Current User ID: ${userId}\n\nPublic Safety Tracking System v2.1 Desktop Edition`);
    }

    /**************** DOM INITIALIZATION *****************/
    document.addEventListener('DOMContentLoaded', async () => {
      // Run verification first
      const isValidUser = await initVerification();
      
      if (!isValidUser) {
        // If verification failed, we should have redirected already
        // But just in case, hide the dashboard
        document.getElementById('dashboard').style.display = 'none';
        return;
      }
      
      // If we reach here, user is valid and not on mobile
      initMap();
      initDashboard();
      
      lucide.createIcons();
      document.getElementById('exitFullscreenBtn').style.display = 'none';
    });

    // expose functions
    window.refreshNow = refreshNow;
    window.openDirections = openDirections;
    window.shareUrl = shareUrl;
    window.showUserInfo = showUserInfo;
    window.openLogsPanel = openLogsPanel;
    window.closeLogsPanel = closeLogsPanel;
    window.switchLogsMode = switchLogsMode;
    window.changeLogsPage = changeLogsPage;
    window.enterFullScreenMap = enterFullScreenMap;
    window.exitFullScreenMap = exitFullScreenMap;
    window.toggleAutoScroll = toggleAutoScroll;
    window.changeAudioPage = changeAudioPage;
    window.changePhotoPage = changePhotoPage;
    window.playAudio = playAudio;
    window.viewPhoto = viewPhoto;
    window.openAudioPanel = openAudioPanel;
    window.closeAudioPanel = closeAudioPanel;
    window.openPhotoPanel = openPhotoPanel;
    window.closePhotoPanel = closePhotoPanel;
  </script>
</body>
</html>