<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Public Safety System</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root{
      --panel-bg:#2e3134;
      --card-bg:#323639;
      --muted:#bfc3c6;
      --accent:#2f78d8;
      --danger:#ea4335;
      --success:#34a853;
      --soft:#f4f6f7;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
      background: #e6e6e6;
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow: hidden; /* Prevent scrolling when modal is open */
    }

    /* Login Modal Styles */
    .login-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      /* Dark semi-transparent overlay to make the blur pop */
      background: rgba(0, 0, 0, 0.6); 
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    
    .login-modal.hidden {
      pointer-events: none;
      opacity: 0;
    }

    .login-container {
      background: linear-gradient(180deg,#28343f 0%, #23282b 100%);
      border-radius: 12px;
      padding: 30px; /* Reduced padding */
      width: 380px; /* Reduced width for better scaling */
      box-shadow: 0 25px 70px rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.15);
      text-align: center;
      position: relative;
      z-index: 1001;
    }
    
    .login-logo {
      margin-bottom: 20px;
    }
    
    .login-logo h1 {
      color: white;
      margin: 0;
      font-size: 24px; /* Slightly smaller */
      font-weight: 600;
    }
    
    .login-logo p {
      color: var(--muted);
      margin: 6px 0 0;
      font-size: 13px;
    }
    
    .login-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .form-group {
      text-align: left;
    }
    
    .form-group label {
      display: block;
      color: var(--soft);
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 500;
    }
    
    .form-group input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      color: white;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.08);
    }
    
    .login-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 5px;
    }
    
    .login-btn:hover {
      background: #2563c7;
    }
    
    .login-footer {
      margin-top: 20px;
      color: var(--muted);
      font-size: 12px;
    }

    /* Card container */
    .dashboard{
      /* Reduced width to mimic 80% zoom feel on 100% screen */
      width: 880px; 
      background: linear-gradient(180deg,#28343f 0%, #23282b 100%);
      border-radius: 10px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      overflow:hidden;
      color:var(--soft);
      transition: filter 0.3s ease;
      /* Dashboard is visible by default now, but blurred via JS class */
      display: block; 
    }

    /* This class is added when modal is open */
    .dashboard.blurred-bg {
      filter: blur(8px) brightness(0.7);
      pointer-events: none;
      user-select: none;
    }

    /* header */
    .dash-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 20px; /* Compact padding */
      background: linear-gradient(180deg,#2b3b44,#263238);
      border-bottom:1px solid rgba(255,255,255,0.03);
    }
    .dash-title{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .dash-title h2{
      margin:0;
      font-size:18px; /* Slightly smaller */
      letter-spacing:0.2px;
      font-weight:600;
      color:#fff;
    }
    .dash-actions{
      display:flex;
      gap:14px;
      align-items:center;
      color:rgba(255,255,255,0.9);
      font-weight:600;
    }
    .icon-btn{
      display:flex;
      gap:6px;
      align-items:center;
      cursor:pointer;
      padding:5px 8px;
      border-radius:6px;
      color:var(--soft);
      font-size: 13px;
      opacity:0.95;
    }
    .icon-btn .dot{
      width:8px;height:8px;background:#fff;border-radius:50%;
    }

    /* Main content */
    .dash-main{
      display:grid;
      grid-template-columns: 290px 1fr; /* Left col smaller */
      gap:12px; /* Tighter gap */
      padding:14px; /* Tighter padding */
      align-items:start;
    }

    /* left column cards */
    .left-col{
      display:flex;
      flex-direction:column;
      gap:10px; /* Tighter gap */
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius:8px;
      padding:12px; /* Tighter padding */
      border:1px solid rgba(0,0,0,0.25);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
    }

    .card h4{
      margin:0 0 6px 0;
      font-size:14px;
      color:var(--soft);
      font-weight: 600;
    }
    .small-muted{ font-size:12px; color:var(--muted); margin-bottom:4px; }

    .device-row{ display:flex; gap:8px; align-items:center; }
    .status-bullet{
      width:12px;height:12px;border-radius:50%;display:inline-block;border:2px solid rgba(255,255,255,0.06);
    }
    .status-online{ background:var(--success); }
    .status-offline{ background:var(--danger); }
    .stat-line{ font-size:13px; color:var(--soft); margin:6px 0; }

    /* Device card layout */
    .device-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .device-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 3px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .device-line:last-child {
      border-bottom: none;
    }
    .device-label {
      font-size: 12px;
      color: var(--muted);
    }
    .device-value {
      font-size: 13px;
      color: var(--soft);
      font-weight: 500;
    }

    /* Location card */
    .loc-grid{ font-size:13px; color:var(--soft); line-height:1.35; }

    /* Settings card */
    .setting-row{ display:flex; align-items:center; justify-content:space-between; padding:6px 0; }
    .toggle{
      width:34px; height:18px; border-radius:20px; background:rgba(255,255,255,0.07);
      position:relative; cursor:pointer;
    }
    .toggle .dot{ width:14px;height:14px;background:#fff;border-radius:50%; position:absolute; top:2px; left:2px; transition:all .18s;}
    .toggle.on{ background:var(--accent); }
    .toggle.on .dot{ left:18px; }

    /* right column: map card and placeholder */
    .map-card{
      display:flex; flex-direction:column; gap:10px;
    }
    .map-frame{
      background:#fff; border-radius:8px; padding:10px; box-shadow: 0 8px 20px rgba(0,0,0,0.18);
      border:1px solid rgba(0,0,0,0.06);
    }
    #map{ height:180px; border-radius:6px; } /* Reduced Height */

    .map-controls{ display:flex; gap:8px; margin-top:10px; align-items:center; }
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border-radius:6px; border:none; cursor:pointer;
      font-weight:700; font-size:13px;
    }
    .btn-refresh{ background:#2f78d8; color:#fff; border:2px solid rgba(0,0,0,0.06); }
    .btn-directions{ background:transparent; color:#2f78d8; border:2px solid rgba(47,120,216,0.15); box-shadow:none; }
    .btn-website{ background:#444; color:#fff; border:2px solid rgba(0,0,0,0.08); opacity:0.95; }
    .btn.disabled{ opacity:0.45; cursor:not-allowed; }

    /* big placeholder below map */
    .placeholder{
      margin-top:0; height:140px; border-radius:8px; border:2px dashed rgba(255,255,255,0.06);
      display:flex; align-items:center; justify-content:center; color:rgba(255,255,255,0.06); font-weight:700; font-size: 14px;
    }

    /* status panel bottom row */
    .bottom-row{ padding:10px 18px; display:flex; gap:20px; align-items:center; justify-content:space-between; border-top:1px solid rgba(255,255,255,0.03); color:var(--muted); font-size:12px; }

    /* responsive */
    @media (max-width:900px){
      .dashboard{ width:96%; }
      .dash-main{ grid-template-columns: 1fr; }
      .left-col{ order:2 }
      .map-card{ order:1 }
    }
  </style>
</head>
<body>

  <div class="dashboard blurred-bg" id="dashboard">
    <div class="dash-header">
      <div class="dash-title">
        <h2>Public Safety System</h2>
      </div>

      <div class="dash-actions">
        <div class="icon-btn" title="Share" onclick="shareUrl()">SHARE</div>
        <div class="icon-btn" title="Profile" onclick="showUserInfo()">üë§</div>
        <div class="icon-btn" title="Logout" onclick="logout()">LOGOUT</div>
      </div>
    </div>

    <div class="dash-main">
      <div class="left-col">
        <div class="card">
          <h4>Device</h4>
          <div class="device-info">
            <div class="device-line">
              <span class="device-label">Device ID:</span>
              <span class="device-value" id="deviceId">unavailable</span>
            </div>
            <div class="device-line">
              <span class="device-label">Status:</span>
              <span class="device-value" id="deviceStatus">unavailable</span>
            </div>
            <div class="device-line">
              <span class="device-label">Battery:</span>
              <span class="device-value" id="batteryInfo">unavailable</span>
            </div>
          </div>
        </div>

        <div class="card">
          <h4>Location</h4>
          <div class="loc-grid">
            <div><span class="small-muted">Last Updated:</span> <span id="lastUpdated">unavailable</span></div>
            <div><span class="small-muted">Latitude:</span> <span id="latVal">unavailable</span></div>
            <div><span class="small-muted">Longitude:</span> <span id="lngVal">unavailable</span></div>
            <div><span class="small-muted">Accuracy:</span> <span id="accVal">unavailable</span></div>
            <div style="margin-top:6px"><span class="small-muted">Address:</span>
              <div id="addrVal" style="margin-top:4px;color:var(--soft);">unavailable</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h4>Settings</h4>

          <div class="setting-row">
            <div>
              <div class="small-muted">Auto Scroll</div>
            </div>
            <div>
              <div id="autoScrollToggle" class="toggle" onclick="toggleAutoScroll()"><div class="dot"></div></div>
            </div>
          </div>

          <div class="setting-row">
            <div>
              <div class="small-muted">Device Path History</div>
            </div>
            <div>
              <div id="historyToggle" class="toggle" onclick="toggleHistory()"><div class="dot"></div></div>
            </div>
          </div>

          <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;">
            <div>
              <div class="small-muted">Auto Refresh</div>
            </div>
            <div>
              <select id="autoRefreshSelect" style="padding:4px 8px;border-radius:6px;border:none;background:#fff;font-weight:700;font-size:12px" onchange="changeAutoRefresh()">
                <option value="0">Off</option>
                <option value="5000" selected>5 sec</option>
                <option value="10000">10 sec</option>
                <option value="60000">1 min</option>
                <option value="900000">15 min</option>
              </select>
            </div>
          </div>

        </div>
      </div>

      <div class="map-card">
        <div class="map-frame">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div style="font-weight:800;color:#333;font-size:13px;">OpenStreetMap</div>
            <div style="font-size:11px;color:#666">Map Provider</div>
          </div>

          <div id="map"></div>

          <div class="map-controls">
            <button id="refreshBtn" class="btn btn-refresh" onclick="refreshNow()">‚ü≥ Refresh</button>

            <button id="dirBtn" class="btn btn-directions disabled" onclick="openDirections()">‚§¥ Directions</button>

            <button id="websiteBtn" class="btn btn-website disabled" onclick="openWebsite()">üåê Website</button>
          </div>
        </div>

        <div class="placeholder">
          DEVICE PATH / EXTRA PANEL
        </div>
      </div>
    </div>

    <div class="bottom-row">
      <div>
        <strong style="color:var(--soft)">User ID:</strong> <span id="bottomUser">unavailable</span>
      </div>
      <div>
        <strong style="color:var(--soft)">Map Provider:</strong> OpenStreetMap
      </div>
      <div>
        <strong style="color:var(--soft)">Device:</strong> <span id="bottomDevice">unavailable</span>
      </div>
    </div>
  </div>

  <div id="loginModal" class="login-modal">
    <div class="login-container">
      <div class="login-logo">
        <h1>Public Safety System</h1>
        <p>Secure Location Tracking Dashboard</p>
      </div>
      
      <form id="loginForm" class="login-form">
        <div class="form-group">
          <label for="userIdInput">User ID</label>
          <input 
            type="text" 
            id="userIdInput" 
            placeholder="Enter your User ID" 
            required
            autocomplete="off"
          >
        </div>
        
        <button type="submit" class="login-btn">Access Dashboard</button>
      </form>
      
      <div class="login-footer">
        Enter your assigned User ID to access the tracking system
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /**************** AUTHENTICATION SYSTEM *****************/
    function getUrlParams(){
      return Object.fromEntries(new URLSearchParams(window.location.search).entries());
    }
    
    function getUserId(){
      const p = getUrlParams();
      return p.userId || p.userid || p.id || null;
    }
    
    function updateUrlUser(userId){
      const u = new URL(window.location);
      if(userId) u.searchParams.set('userId', userId); 
      else u.searchParams.delete('userId');
      window.history.replaceState({}, '', u);
    }
    
    function authenticateUser(userId) {
      if (userId && userId.trim() !== '') {
        updateUrlUser(userId);
        
        // UI State Changes for Login
        document.getElementById('loginModal').classList.add('hidden');
        // Remove the blur class from dashboard
        document.getElementById('dashboard').classList.remove('blurred-bg');
        
        initDashboard();
        return true;
      }
      return false;
    }
    
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        updateUrlUser('');
        
        // UI State Changes for Logout
        document.getElementById('loginModal').classList.remove('hidden');
        // Add the blur class back
        document.getElementById('dashboard').classList.add('blurred-bg');
        
        // Clear any intervals
        if (autoRefreshTimer) {
          clearInterval(autoRefreshTimer);
          autoRefreshTimer = null;
        }
      }
    }
    
    function showUserInfo() {
      const userId = getUserId();
      alert(`Current User ID: ${userId}\n\nTo change user, please logout and login with a different ID.`);
    }
    
    // Check for userId on page load
    document.addEventListener('DOMContentLoaded', () => {
      // We must init the map immediately so it renders in the background for the blur effect
      // even if user is not logged in
      initMap(); 
      
      const userId = getUserId();
      if (userId) {
        // User is already authenticated via URL
        authenticateUser(userId);
      } else {
        // Ensure blur is on
        document.getElementById('dashboard').classList.add('blurred-bg');
      }
      
      // Setup login form
      document.getElementById('loginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const userId = document.getElementById('userIdInput').value.trim();
        if (authenticateUser(userId)) {
          // Success
          document.getElementById('userIdInput').value = '';
        } else {
          alert('Please enter a valid User ID');
        }
      });
    });

    /**************** DASHBOARD FUNCTIONALITY *****************/
    const API_URL = 'https://jwki58wsv8.execute-api.ap-south-1.amazonaws.com/prod/location';
    let autoRefreshIntervalMs = 5000;
    let autoRefreshTimer = null;
    const UNAVAIL = 'unavailable';

    /**************** STATE *****************/
    let map, marker, accuracyCircle;
    let currentLat=null, currentLng=null;
    let isAutoScroll = false;
    let showHistory = false;

    /**************** HELPERS *****************/
    function setText(id, value){
      document.getElementById(id).textContent = (value === undefined || value === null || value === '') ? UNAVAIL : value;
    }
    function setAttrDisabled(el, disabled){
      if(!el) return;
      if(disabled) el.classList.add('disabled'); else el.classList.remove('disabled');
    }

    /**************** SHARE FUNCTIONALITY *****************/
    function shareUrl(){
      const currentUrl = window.location.href;
      if (navigator.share) {
        navigator.share({
          title: 'Public Safety System',
          text: 'Check out this public safety system location tracker',
          url: currentUrl
        })
        .catch(err => {
          console.log('Error sharing:', err);
          fallbackShare(currentUrl);
        });
      } else {
        fallbackShare(currentUrl);
      }
    }

    function fallbackShare(url) {
      navigator.clipboard.writeText(url).then(() => {
        alert('URL copied to clipboard: ' + url);
      }).catch(err => {
        prompt('Copy this URL to share:', url);
      });
    }

    /**************** MAP INIT *****************/
    function initMap(){
      // Prevent re-initialization
      if(map) return; 

      map = L.map('map', { zoomControl:true }).setView([20.5937,78.9629],5);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom:19,
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      marker = L.marker([20.5937,78.9629]).addTo(map);
      accuracyCircle = L.circle([20.5937,78.9629], {radius:0, color:'#2f78d8', opacity:0.2, fillOpacity:0.06}).addTo(map);
    }

    /**************** DASHBOARD INIT *****************/
    function initDashboard(){
      // Map is already inited in DOMContentLoaded
      
      const userId = getUserId();
      if(userId){
        document.getElementById('bottomUser').textContent = userId;
        document.getElementById('deviceId').textContent = userId;
        // fetch once and start if auto-refresh selected
        fetchAndApply();
      } else {
        // show unavaille until login param provided
        applyUnavailableUI();
      }

      // wire up initial selects/controls - set auto refresh to 5 seconds by default
      document.getElementById('autoRefreshSelect').value = '5000';
      
      // Start auto refresh by default (5 seconds)
      if(!autoRefreshTimer) {
         autoRefreshTimer = setInterval(()=>{ fetchAndApply(); }, autoRefreshIntervalMs);
      }
    }

    /**************** FETCH API *****************/
    async function fetchAndApply(){
      const userId = getUserId();
      if(!userId){
        applyUnavailableUI();
        return;
      }

      // show fetching small indicator
      setText('lastUpdated', 'Fetching...');

      try{
        const resp = await fetch(`${API_URL}?userId=${encodeURIComponent(userId)}`);
        const j = await resp.json();

        // handle AWS lambda style returns with body
        let payload;
        if(j && typeof j === 'object' && j.body){
          try{ payload = typeof j.body === 'string' ? JSON.parse(j.body) : j.body; } catch(e){ payload = j.body; }
        } else payload = j;

        // expected shape: { success:true, data: { ... } }
        let data = payload && payload.data ? payload.data : payload;

        if(!data || Object.keys(data).length===0){
          applyUnavailableUI();
          return;
        }

        // use provided timestamp field if present (string)
        const apiTimestamp = data.timestamp ?? data.time ?? data.ts ?? null;

        // coordinates
        const lat = parseFloat(data.latitude ?? data.lat ?? NaN);
        const lng = parseFloat(data.longitude ?? data.lon ?? data.lng ?? NaN);

        if(!isFinite(lat) || !isFinite(lng)){
          applyUnavailableUI(data);
          return;
        }

        currentLat = lat; currentLng = lng;

        // update map
        marker.setLatLng([lat,lng]);
        const acc = (data.accuracy !== undefined && data.accuracy !== null) ? Number(data.accuracy) : 0;
        accuracyCircle.setLatLng([lat,lng]);
        accuracyCircle.setRadius(acc || 0);

        if(isAutoScroll){
          map.setView([lat,lng], 15, {animate:true});
        }

        // popup
        marker.bindPopup(`<b>User:</b> ${userId}<br><b>Lat:</b> ${lat.toFixed(6)}<br><b>Lng:</b> ${lng.toFixed(6)}<br><b>Time:</b> ${apiTimestamp ? apiTimestamp : new Date().toLocaleString()}`).openPopup();

        // Fill info fields (use UNAVAIL when missing)
        setText('deviceId', data.userId ?? userId);
        setText('bottomUser', data.userId ?? userId);
        setText('bottomDevice', data.device ?? UNAVAIL);
        setText('deviceStatus', data.status ?? UNAVAIL);

        setText('batteryInfo', data.battery ? `${data.battery}% ${data.charging ? '(Charging)' : '(Not Charging)'}` : UNAVAIL);

        setText('latVal', lat.toFixed(6));
        setText('lngVal', lng.toFixed(6));
        setText('accVal', data.accuracy ? `${Math.round(data.accuracy)} meters` : UNAVAIL);

        // address: use API field if present, otherwise reverse geocode from nominatim
        if(data.address) {
          setText('addrVal', data.address);
        } else {
          // attempt nominatim reverse geocode
          fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
            .then(r=>r.json())
            .then(d=>{
              const disp = d && d.display_name ? d.display_name : UNAVAIL;
              document.getElementById('addrVal').textContent = disp;
            }).catch(err=>{
              document.getElementById('addrVal').textContent = UNAVAIL;
            });
        }

        // last update: prefer API timestamp
        if(apiTimestamp){
          const parsed = new Date(apiTimestamp);
          if(!isNaN(parsed.getTime())) setText('lastUpdated', parsed.toLocaleString());
          else setText('lastUpdated', apiTimestamp);
        } else {
          setText('lastUpdated', new Date().toLocaleString());
        }

        setText('bottomDevice', data.device ?? UNAVAIL);

        // Enable / disable Get Directions and Website buttons
        const dirBtn = document.getElementById('dirBtn');
        const websiteBtn = document.getElementById('websiteBtn');

        setAttrDisabled(dirBtn, false);
        dirBtn.onclick = openDirections;

        if(data.website){
          websiteBtn.classList.remove('disabled');
          websiteBtn.onclick = () => {
            const url = data.website.startsWith('http') ? data.website : 'https://'+data.website;
            window.open(url, '_blank');
          };
          websiteBtn.textContent = 'üåê Website';
        } else {
          websiteBtn.classList.add('disabled');
          websiteBtn.onclick = null;
          websiteBtn.textContent = 'üåê unavailable';
        }

      } catch(err){
        console.error('Fetch error', err);
        applyUnavailableUI();
      }
    }

    /**************** APPLY UNAVAILABLE UI *****************/
    function applyUnavailableUI(data){
      const uid = getUserId();
      setText('deviceId', data && data.userId ? data.userId : (uid || UNAVAIL));
      setText('bottomUser', data && data.userId ? data.userId : (uid || UNAVAIL));
      setText('deviceStatus', data && data.status ? data.status : UNAVAIL);
      setText('batteryInfo', data && data.battery ? `${data.battery}%` : UNAVAIL);
      setText('latVal', UNAVAIL);
      setText('lngVal', UNAVAIL);
      setText('accVal', UNAVAIL);
      setText('addrVal', UNAVAIL);
      setText('lastUpdated', UNAVAIL);
      setText('bottomDevice', data && data.device ? data.device : UNAVAIL);

      setAttrDisabled(document.getElementById('dirBtn'), true);
      setAttrDisabled(document.getElementById('websiteBtn'), true);
    }

    /**************** BUTTONS *****************/
    function refreshNow(){
      fetchAndApply();
    }

    function openDirections(){
      if(!currentLat || !currentLng){
        alert('Coordinates not available');
        return;
      }
      const url = `https://www.google.com/maps/dir/?api=1&destination=${currentLat},${currentLng}&travelmode=driving`;
      window.open(url, '_blank');
    }

    function openWebsite(){
      const websiteBtn = document.getElementById('websiteBtn');
      if(websiteBtn.classList.contains('disabled')){
        alert('Website unavailable');
      }
    }

    /**************** SETTINGS UI *****************/
    function toggleAutoScroll(){
      isAutoScroll = !isAutoScroll;
      const el = document.getElementById('autoScrollToggle');
      if(isAutoScroll) el.classList.add('on'); else el.classList.remove('on');
      
      if(isAutoScroll && currentLat && currentLng){
        map.setView([currentLat, currentLng], 15, {animate:true});
      }
    }

    function toggleHistory(){
      showHistory = !showHistory;
      const el = document.getElementById('historyToggle');
      if(showHistory) el.classList.add('on'); else el.classList.remove('on');
      if(showHistory) alert('Device Path History: ON (placeholder)');
    }

    function changeAutoRefresh(){
      const val = Number(document.getElementById('autoRefreshSelect').value);
      autoRefreshIntervalMs = val;
      if(autoRefreshTimer) { clearInterval(autoRefreshTimer); autoRefreshTimer = null; }
      if(autoRefreshIntervalMs > 0){
        autoRefreshTimer = setInterval(()=>{ fetchAndApply(); }, autoRefreshIntervalMs);
      }
    }

    // expose functions
    window.refreshNow = refreshNow;
    window.openDirections = openDirections;
    window.openWebsite = openWebsite;
    window.shareUrl = shareUrl;
    window.logout = logout;
    window.showUserInfo = showUserInfo;
  </script>
</body>
</html>